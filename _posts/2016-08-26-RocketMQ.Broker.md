---
layout: post
title: RocketMQ Broker
category: RocketMQ
description: Broker 负责消息的存储和转发。将消息存储到文件中，根据消费者请求的消息类型，从文件中获取消息然后发送给消费者。
---

# RocketMQ.Broker
Broker 负责消息的存储和转发。将消息存储到文件中，根据消费者请求的消息类型，从文件中获取消息然后发送给消费者。<br/>

服务端通过命令启动Broker，调用`BrokerStartup`的`main`方法。`BrokerStartup`加载默认的配置文件，BrokerConfig、NettyServerConfig、NettyClientConfig和`MessageStoreConfig`<br/>

* BrokerConfig 保存Broker的基本信息以及NameServer地址等信息
* NettyServerConfig 用于启动Broker的服务端实例监听客户端的请求
* NettyClientConfig 用于启动Netty服务端来监听NameServer地址变化服务
* MessageStoreConfig 用于创建默认的DefaultMessageStore用于存储消息的文件的相关配置信息

## Receive Message
NettyServerHandler接收新消息请求，新消息的请求类型为SEND_MESSAGE，调用NettyRemotingAbstract的processMessageReceived方法处理消息。NettyRemotingAbstract将新消息请求封装成Task任务，将该任务提交到线程池sendMessageExecutor中处理。线程池调用SendMessageProcessor的processRequest方法处理任务。SendMessageProcess将消息放到DefaultMessageStore中。DefaultMessageStore将消息持久化到文件，并将消息分发给DispatchMessageService。DispatchMessageService将消息放入ConsumeQueue队列中。

## Store Message
SendMessageProcess将消息放到DefaultMessageStore中。`DefaultMessageStore`调用`CommitLog`来存储消息。`CommitLog`调用`MapedFile`，`MapedFile`调用默认的添加消息回调方法，将消息添加到缓存BygeBuff中。最后返回结果PUT_OK状态码给生产者。

## Send Message
消费者发生SEND_MESSAGE类型的消息请求，Broker接收到该类型的请求时，调用`PullMessageProcessor`处理程序来处理该请求。`PullMessageProcessor`首先对该请求做一系列的校验，校验通过后从`DefaultMessageStore`中获取消息。`DefaultMessageStore`根据请求的Topic和QueueId从ConsumeQueue队列中获取该消息，将消息添加到`GetMessageResult`缓存中。最后将`GetMessageResult`封装到`RemotingCommand`中返回给消费者。
