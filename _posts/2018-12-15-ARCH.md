
---
layout: post
title: 云仓平台
category: 架构
description: 云仓平台，解决仓储物流供应链一站式服务，包括订单、仓储、物流等服务。
---

# 平台架构理论

结合《Java工程师修炼之道》读书理论。

后端基础设施

1. 请求统一入口--API网关
* 负载均衡
* API访问权限控制
* 用户鉴权

一般是Nginx做负载均衡，然后在每个业务应用里做API接口的访问权限控制和用户鉴权，更优化一点的方式是把后两者做成公共类库供所有业务调用。API网关：将三者需求集成到一个服务，比如开源的Kong。

但是API网关一个问题是所有API请求都要经过网关，它很容易成为系统性能瓶颈。因此，可以让业务应用直接对接统一认证中心，在基础框架层面保证每个API调用都需要先通过认证中心的认证，这里可以采取缓存认证结果避免认证中心产生过大的请求压力。

2. 缓存、数据库、搜索引擎、消息队列
* 缓存：通常被用来解决热点数据的访问问题，提供数据查询性能。
* 数据库：主流关系型数据库Mysql和PostgreSQL，NoSQL HBase用于大数据领域的列数据库，一般不用于业务数据库。
* 搜索引擎：针对全文检索以及数据各种维度查询设计的软件，Solr和Elasticsearch，它们都是基于Lucene实现的。
* 消息队列：数据传输的一种方式，包括为日志设计的Kafka以及重事务的RabbitMQ等。

3. 统一认证中心
* 用户注册、登录验证、Token鉴权
* 内部信息系统用户的管理和登录鉴权
能够集中对所有平台的信息进行管理，提供统一的认证服务。尤其在很多业务需要共享用户数据的时候。

4. 单点登录系统
只需要一次用户登录，就能够进入多个业务应用（权限可以不相同）。

5. 统一配置中心
在Java后端应用中，通常将配置文件写在Properties等文件中，修改的时候只需要更新文件重新部署即可。统一配置中心是对所有业务的相关配置文件进行管理的服务，能够在线动态修改配置并生效，配置文件可以区分环境（开发、测试、生产等），在Java中可以通过注解、XML配置的方式引入相关配置。百度开源的Disconf或者基于Zookeeper实现的配置存储方案。

6. 服务治理框架
外部调用服务端API一般都是通过HTTP协议或者Socket，内部服务之间的调用，一般都是通过RPC机制进行的。目前主流的RPC协议有：RMI、Hessian、Thrift、Dubbo。当系统服务逐渐增多，RPC调用链越来越复杂时。就需要有一个服务来管理这些服务。

传统ESB企业总线本质上也是一个服务治理方案，但是ESB是作为一种Proxy角色存在于Client和Server端，所有请求都要经过ESB，ESB很容易成为性能瓶颈。

新的一种以配置中心为枢纽的服务治理方案，调用关系只存在于Client和提供服务的Server之间。这种服务治理方案需要支持：
* 服务提供方的注册、管理
* 服务消费者的注册、管理
* 服务的版本管理、负载均衡、流量控制、服务降级、资源隔离
* 服务的容错、熔断

阿里开源的Dubbo目前针对以上做了很好的实现。

7. 统一调度中心
定时调度，比如定时去抓取数据、定时刷新订单的状态等，通常做法是针对各自业务，依赖Linux的Cron机制或者Java中的Quartz来实现。统一调度中心是对所有的调度任务进行管理。

8. 统一日志服务
日志是线上服务能够定位、排查异常最直接的来源。统一日志服务使用单独的日志服务器记录日志，各业务应用通过统一的日志框架将日志输出到日志服务器上。可以通过实现Log4j或者LogBack的appender来实现统一日志框架，然后通过RPC调用将日志打印到日志服务器上。

* 日志收集：场景日志收集方案有Kafka和Flume，以及Logstash，更倾向于数据的预处理 ELK架构。
* 日志传输：通过消息队列将数据传输到数据处理服务中。通常选择Kafka。

还有一个就是数据库和数据仓库间的数据同步问题，将需要分析的数据从数据库同步到诸如Hive这种数据仓库。可以使用Apache Sqoop进行基于时间戳的数据同步，以及阿里开源的Canal基于Binlog的增量同步。

离线数据分析，数据可以有延迟，常用的离线数据分析技术有Hadoop和Spark。

实时数据分析，对数据有实时要求的业务场景，如广告结算、订单结算等。常用的技术有Storm和Spark Streaming。Spark Streaming是基于批量计算的，如果对延迟很敏感的场景，应该使用Storm。最近比较或的有Flink分布式实时计算框架。

实时数据处理一般是基于增量处理的，但是一旦出现故障或数据处理失败，相对于离线来说并不是很靠谱。因此结合离线+实时是目前比较普遍的数据处理方案，有Lambda架构。实时数据分析中还有一个比较常见的场景：多维数据实时分析，即能够组合任意维度进行数据展示和分析，ROLAP和MOLAP方案。

9. 故障监控
将故障监控分为两个层面：
* 系统监控：主要指针对主机的带宽、I/O、CPU、内存、硬盘等硬件资源的监控，可以使用Nagios、Cacti等开源监控软件。
* 业务监控：包括监控和告警。

Java后端技术概览

1.软件开发的核心原则
* 不做重复性劳动
* 不要过度设计和过早优化，这样有利于后续的维护和进一步的扩展
* 只添加必要的功能到应用中
* 开发最佳思路就是先把东西做出来，再去迭代优化。如果一开始就面面俱到，考虑到各种细节，那么很容易转牛角尖而延误项目进度。
* 技术选型很关键，不能盲目求新，一定要选择最合适的。合适自己、合适团队、合适公司目前阶段的。

2. 计算机基础科学知识
* 数据结构，经典的数据结构有字符串、数组、链表、哈希表、树（二叉树、平衡树、红黑树、B树）、堆栈、队列、图。
* 算法：排序和查找，冒泡排序、插入排序、选择排序、归并排序、快速排序、希尔排序、堆排序以及二分查找等。在函数/方法中要注意递归和迭代各自的优缺点。衡量算法性能的空间复杂度和时间复杂度。
* 业务相关算法，压缩算法、LRU缓存算法、缓存一致性、编译原理中的状态机等。
* 计算机网络，HTTP网络协议，基于HTTP的HTTPS安全协议。业务层面，基于HTTP协议的RESTful规范，OAuth2.0对外开放平台协议。SMTP基于TCP/IP的应用协议。
* 设计模式，能够是软件可重用、可扩展、可维护。经典的工厂模式、简单工厂模式、单例模式、观察者模式、代理模式、建筑者模式、门面模式、适配器模式、装饰器模式。

知其然更要知其所以然！“逃离舒适区”，自我总结

Java项目与工程化

1. 主流构建工具--Maven，“约定优于配置”，约定好的一些规范无需再配置。

# 云仓平台架构

A订单业务线：
入库-订单导入、提交、审核、---仓库内的操作---PDA确认数量入库、生成入库报表。
出库-订单导入、提交、审核、---仓库内的操作---PDA确认数量出库、生成出库报表。

订单层面

方案一：
1.新增一种A订单类型业务服务，客户平台要新增导入A订单接口，oms mapper抽象出A订单Mapper。将A订单数据新增到oms数据库。
2.A订单新增成功后，点击提交，发布A订单类型的订单导入消息到订单消息队列。
3.订单平台新增接收A订单类型的订阅服务，新增A订单操作页面、A订单的获取接口（这些都可以跟前面的抽取到一个服务里面）

基于订单层面的新增订单类型，只要新增订单导入、订单查询、订阅订单类型即可。后面是仓库的操作所以可以屏蔽。但是每新增一个订单类型就要改代码，不是很好的设计。所以可以把订单作为可配置。

方案二（用demo实现下）：
订单配置，在已有的订单类型里面选择一个订单类型，然后勾选需要的字段、勾选必填的字段、需要扫描的字段、校验失败的提示信息，点击保存提交。
订单导入，根据客户和订单类型到订单配置表里面查询需要校验的字段，校验不通过抛出定义好的提示信息，校验通过后新增数据库。
订单查询，根据客户和订单类型到订单配置表里面查询需要显示的字段，动态拼接订单查询sql，查询数据。
订阅订单类型，不需要修改，新的订单是在已有的订单类型下的。

以上通过订单配置的设计就可以满足不同客户对同一业务类型的不同需求设计。但是如果是从平台角度新增业务，那就要走方案一。

仓库层面

不需要PDA

XXX订单平台新增确认入库按钮，更新订单状态，将订单数据直接同步到库存表。XXX，不能这样设计，从流程角度上来说，还是要遵守但是可以从客户端层面屏蔽这些不同。
所以即可不需要PDA，订单平台审核后还是按现有流程，发布订单审核通知，任务平台收到通知后，新建入库任务。再提供确认入库接口，可以由任务平台或订单平台来操作。

那新增A订单对现有操作流程有影响吗？比如生成入库任务需要的信息？对于仓库只需要知道是什么商品，多少数量即可。所以流程不用变。

需要PDA，也需要扫描

释放任务、扫描条形码（这里会根据订单类型分为几种扫描方式）、输入数量，确认收货。  ---- 需要知道进度、状态、结果的才会使用消息队列，另外一些场景就可以直接同步数据。

确认收货，数据就会同步到库存平台，客户平台的库存管理就可以查询到库存数据。

报价/计费系统

包含了客户、合同、费用。订阅任务结果消息，任务执行完后，出账单表。财务人员核对账单，确认账单。

报表平台

库存报表不变，直接从库存平台获取数据。入仓报表，就要从任务平台获取（这个在新增A订单会需要修改吗？把仓库的报表定制好就可以，唯一就是需要显示客户订单配置里面的额外字段）。

需要考虑的问题，
1、几个数据库，几个数据中心、几个消息队列、几个缓存、认证中心、配置中心
2、抽取几个基础服务层模块
3、几个业务层模块
4、几个界面层、客户端。

Redis的应用
单点登录、物流信息缓存（考虑下）

RocketMQ的应用
订单消息、任务消息、

Motan
每个业务平台

库的拆分设计（不应这么细）
1个库：仓库  -- 2015/4 6个月
2个库：仓库、权限 2015/10 3个月
3个库：仓库、权限、计费 2016/2 3个月
4个库：订单、仓库、权限、计费 2016/5 10
5个库：订单、库存、任务、权限、计费 2017/3 6
7个库：订单、库存、任务、权限、计费、基础、历史 2017/9

系统架构发展历程
仓库系统 2015/4 6
订单系统+云仓系统 2016/2
客户平台+订单平台+云仓平台 2017/3
客户平台+订单平台+云仓平台+展示平台 2018/2
